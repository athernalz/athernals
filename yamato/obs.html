<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="Cache-Control" content="no-store, max-age=0">
<title>Crickets â€“ OBS</title>
<style>.ver{position:fixed;left:8px;bottom:6px;color:#9ca3af;font-size:12px;opacity:.7}</style>
</head>
<body style="margin:0;background:transparent;">
<div class="ver">v0.0.9</div>
<script>
const CLIENT_ID="n62lboxsur7ytj4lowidq6kdf8spuc";
const hp=new URLSearchParams(location.hash.slice(1));
const token=hp.get("token");
const forceLib=hp.get("lib");
// volume from hash, default 0.7
const volParam=parseFloat(hp.get("vol"));
const volumeLevel=Number.isFinite(volParam)?Math.max(0,Math.min(1,volParam)):0.7;

function loadChatLib(){
  return new Promise((resolve,reject)=>{
    const v="v="+Date.now();
    const tryLoad=(src,next)=>{
      const s=document.createElement("script");
      s.src=src+(src.includes("?")?"&":"?")+v;
      s.onload=()=>window.tmi?resolve():next();
      s.onerror=next;
      document.body.appendChild(s);
    };
    if(forceLib==="cdn") return tryLoad("https://cdnjs.cloudflare.com/ajax/libs/tmi.js/1.8.5/tmi.min.js",()=>reject(new Error("CDN blocked")));
    if(forceLib==="local") return tryLoad("./chatlib.min.js",()=>reject(new Error("Local lib blocked")));
    tryLoad("./chatlib.min.js",()=>tryLoad("https://cdnjs.cloudflare.com/ajax/libs/tmi.js/1.8.5/tmi.min.js",()=>reject(new Error("Local & CDN blocked"))));
  });
}

async function getMe(tok){
  const r=await fetch("https://api.twitch.tv/helix/users",{headers:{Authorization:`Bearer ${tok}`,"Client-Id":CLIENT_ID}});
  const j=await r.json(); return j?.data?.[0]?.login?.toLowerCase()||null;
}

(async function main(){
  if(!token){ console.error("No token in URL."); return; }
  try{ await loadChatLib(); }catch(e){ console.error("tmi load failed",e); return; }
  const me=await getMe(token); if(!me){ console.error("Token invalid/expired"); return; }

  const client=new window.tmi.Client({
    options:{debug:true},
    connection:{secure:true,reconnect:true},
    identity:{username:me,password:`oauth:${token}`},
    channels:[]
  });

  let cooldown=false, ydBlock=false, ydUsers=new Set(), selfCount=0;

  client.on("connected", async ()=>{
    try{
      await Promise.all([
        client.join("yamatosdeath").then(()=>console.log("Joined #yamatosdeath")),
        client.join("athernals7").then(()=>console.log("Joined #athernals7")),
      ]);
    }catch(e){ console.warn("Join error",e); }
  });

  client.on("message",(ch,tags,message)=>{
    const m=message.trim();
    const user=(tags.username||"").toLowerCase();

    if(ch==="#yamatosdeath"){
      if(m==="..."){
        if(!ydBlock){ ydBlock=true; ydUsers=new Set(); }
        ydUsers.add(user);
        if(ydUsers.size>=3 && !cooldown){ trigger(); ydBlock=false; ydUsers.clear(); }
      } else { ydBlock=false; ydUsers.clear(); }
    }
    if(ch==="#athernals7"){
      if(m==="..." && user===me){
        selfCount++;
        if(selfCount>=3 && !cooldown){ trigger(); selfCount=0; }
      } else if(m!=="..."){ selfCount=0; }
    }
  });

  client.connect().catch(e=>console.error("tmi connect error",e));

  function trigger(){
    const s=new Audio("./crickets.mp3");
    s.volume=volumeLevel;
    s.play().catch(e=>console.error("Audio error:",e));
    cooldown=true; setTimeout(()=>cooldown=false,10000);
  }
})();
</script>
</body>
</html>
