<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>yamatosdeath OBS</title>
</head>
<body style="margin:0;background:transparent;">
<script src="https://cdnjs.cloudflare.com/ajax/libs/tmi.js/1.8.5/tmi.min.js"></script>
<script>
const hashParams = new URLSearchParams(window.location.hash.substr(1));
const token = hashParams.get("token");
const CLIENT_ID = "n62lboxsur7ytj4lowidq6kdf8spuc";
let volumeLevel = parseFloat(localStorage.getItem("volumeLevel") || "0.65");

async function getUsernameFromToken(token) {
    const res = await fetch("https://api.twitch.tv/helix/users", {
        headers: {
            "Authorization": `Bearer ${token}`,
            "Client-Id": CLIENT_ID
        }
    });
    const data = await res.json();
    return data.data[0].login;
}

async function connectChat() {
    if (!token) return console.error("No token provided in URL");

    const username = await getUsernameFromToken(token);

    const client = new tmi.Client({
        options: { debug: false },
        identity: {
            username: username,
            password: `oauth:${token}`
        },
        channels: ["yamatosdeath", "athernals7"]
    });

    let streakUsers = new Set();
    let testCount = 0;
    let cooldown = false;

    client.connect();

    client.on("message", (channel, tags, message) => {
        const msg = message.trim();
        
        // Normal channel logic
        if (channel === "#yamatosdeath") {
            if (msg === "...") {
                streakUsers.add(tags.username);
                if (streakUsers.size >= 3 && !cooldown) {
                    triggerSound();
                    cooldown = true;
                    setTimeout(() => cooldown = false, 10000);
                    streakUsers.clear();
                }
            } else {
                streakUsers.clear();
            }
        }

        // Testing channel logic
        if (channel === "#athernals7" && tags.username.toLowerCase() === "athernals7") {
            if (msg === "...") {
                testCount++;
                if (testCount >= 3 && !cooldown) {
                    triggerSound();
                    cooldown = true;
                    setTimeout(() => cooldown = false, 10000);
                    testCount = 0;
                }
            } else {
                testCount = 0;
            }
        }
    });

    function triggerSound() {
        const sound = new Audio("./crickets.mp3");
        sound.volume = volumeLevel;
        sound.play().catch(err => console.error("Audio error:", err));
    }
}

connectChat();
</script>
</body>
</html>
