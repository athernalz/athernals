<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>yamatosdeath</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #0e0e10;
        color: white;
        display: flex;
        justify-content: center;
        padding: 20px;
    }
    .container {
        background: #18181b;
        border-radius: 12px;
        padding: 20px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    h1 {
        font-size: 1.4rem;
        margin-bottom: 10px;
    }
    button {
        background-color: #9147ff;
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 14px;
        cursor: pointer;
        margin: 4px;
        transition: background 0.2s;
    }
    button:hover {
        background-color: #772ce8;
    }
    button:disabled {
        background-color: #333;
        cursor: not-allowed;
    }
    .status-chip {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 6px;
        background: #333;
        font-size: 12px;
        margin: 4px 2px;
    }
    .slider-container {
        display: flex;
        align-items: center;
        margin-top: 10px;
    }
    .slider-container input {
        flex: 1;
    }
    #log {
        margin-top: 10px;
        background: black;
        padding: 8px;
        font-size: 12px;
        height: 150px;
        overflow-y: auto;
        border-radius: 6px;
    }
</style>
</head>
<body>
<div class="container">
    <h1>yamatosdeath</h1>
    <button id="loginBtn">Login with Twitch</button>
    <button id="connectBtn" disabled>Connect</button>
    <button id="soundBtn">Enable Sound</button>
    <span class="status-chip" id="connStatus">disconnected</span>
    <div class="slider-container">
        <label for="volume">Volume:</label>
        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.4">
        <span id="volumeLabel">40%</span>
    </div>
    <div id="log"></div>
</div>

<script src="./tmi.min.js"></script>
<script>
const CLIENT_ID = "n62lboxsur7ytj4lowidq6kdf8spuc";
const REDIRECT_URI = "https://www.athernals.com/yamato/";
const SCOPE = "chat:read";
let token = null;
let username = null;
let client = null;
let soundEnabled = false;
let streakUsers = new Set();
let cooldown = false;

const audio = new Audio("./crickets.mp3");
audio.volume = 0.4;

function logMsg(msg) {
    const logBox = document.getElementById("log");
    const now = new Date().toLocaleTimeString();
    logBox.innerHTML += `[${now}] ${msg}<br>`;
    logBox.scrollTop = logBox.scrollHeight;
}

document.getElementById("loginBtn").onclick = () => {
    const url = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${SCOPE}`;
    window.location = url;
};

async function getUsernameFromToken(token) {
    const res = await fetch("https://api.twitch.tv/helix/users", {
        headers: {
            "Authorization": `Bearer ${token}`,
            "Client-Id": CLIENT_ID
        }
    });
    const data = await res.json();
    return data.data[0].login;
}

document.getElementById("connectBtn").onclick = async () => {
    if (!token) {
        logMsg("No token found, please login.");
        return;
    }
    username = await getUsernameFromToken(token);
    logMsg(`Connecting as ${username}...`);
    client = new tmi.Client({
        options: { debug: true },
        identity: {
            username: username,
            password: `oauth:${token}`
        },
        channels: ["yamatosdeath"]
    });

    client.connect().then(() => {
        document.getElementById("connStatus").innerText = "connected";
        logMsg("Connected to chat.");
    }).catch(err => logMsg(`Connection error: ${err}`));

    client.on("message", (channel, tags, message) => {
        if (message.trim() === "...") {
            streakUsers.add(tags.username);
            if (streakUsers.size >= 3 && !cooldown && soundEnabled) {
                audio.play();
                logMsg("Crickets triggered!");
                cooldown = true;
                setTimeout(() => cooldown = false, 5000);
                streakUsers.clear();
            }
        } else {
            streakUsers.clear();
        }
    });
};

document.getElementById("soundBtn").onclick = () => {
    soundEnabled = !soundEnabled;
    document.getElementById("soundBtn").innerText = soundEnabled ? "Sound Enabled" : "Enable Sound";
    logMsg(`Sound ${soundEnabled ? "enabled" : "disabled"}`);
};

document.getElementById("volume").oninput = (e) => {
    audio.volume = parseFloat(e.target.value);
    document.getElementById("volumeLabel").innerText = Math.round(audio.volume * 100) + "%";
};

// Parse token from hash fragment after redirect
if (window.location.hash) {
    const hashParams = new URLSearchParams(window.location.hash.substr(1));
    token = hashParams.get("access_token");
    if (token) {
        logMsg("Access token acquired.");
        document.getElementById("connectBtn").disabled = false;
    }
}
</script>
</body>
</html>
