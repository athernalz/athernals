<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>yamatosdeath</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-store, max-age=0">
<style>
    body { font-family: Arial, sans-serif; background: #1e1e1e; color: white; margin:0; padding:0; text-align:center; }
    h1 { margin-top: 20px; }
    button { padding: 10px 20px; margin: 10px; font-size: 18px; cursor: pointer; background: #4a90e2; border: none; border-radius: 5px; color: white; }
    button:hover { background: #357ab8; }
    #log { background: black; padding: 10px; height: 300px; overflow-y: auto; font-family: monospace; text-align:left; }
    .ver { position: fixed; bottom: 5px; left: 10px; color: gray; font-size: 12px; }
</style>
</head>
<body>
    <h1>yamatosdeath</h1>
    <button id="loginBtn">Login with Twitch</button>
    <button id="connectBtn" style="display:none;">Connect</button>
    <button id="enableSoundBtn" style="display:none;">Enable Sound</button>
    <div id="log"></div>
    <div class="ver">v0.0.9</div>

<script src="./chatlib.min.js?v=9"></script>
<script>
const CLIENT_ID = "n62lboxsur7ytj4lowidq6kdf8spuc";
const REDIRECT_URI = "https://www.athernals.com/yamato/";
const CHANNEL = "yamatosdeath";

const cricket = new Audio("crickets.sfx");
let token = localStorage.getItem("tw_token") || null;
let cooldown = false;
let streak = 0;

const logDiv = document.getElementById("log");
function log(msg) {
    const line = document.createElement("div");
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logDiv.appendChild(line);
    logDiv.scrollTop = logDiv.scrollHeight;
}

// URL volume
const urlParams = new URLSearchParams(window.location.search);
const volume = parseFloat(urlParams.get("vol")) || 0.7;
cricket.volume = volume;

document.getElementById("loginBtn").onclick = () => {
    const url = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=chat:read`;
    window.location = url;
};

if (window.location.hash.includes("access_token")) {
    token = window.location.hash.match(/access_token=([^&]+)/)[1];
    localStorage.setItem("tw_token", token);
    window.location.hash = "";
}

if (token) {
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("connectBtn").style.display = "inline-block";
}

document.getElementById("enableSoundBtn").onclick = () => {
    cricket.play().then(() => {
        cricket.pause();
        cricket.currentTime = 0;
        log("Sound enabled");
    });
};

document.getElementById("connectBtn").onclick = () => {
    document.getElementById("connectBtn").style.display = "none";
    document.getElementById("enableSoundBtn").style.display = "inline-block";

    const client = new tmi.Client({
        options: { debug: true },
        connection: { secure: true, reconnect: true },
        identity: { username: "justinfan" + Math.floor(Math.random()*80000), password: "oauth:" + token },
        channels: []
    });

    client.connect().then(() => {
        log("Connected to Twitch IRC.");
        client.join(CHANNEL).then(() => log(`Joined #${CHANNEL}`));
    });

    client.on("message", (ch, tags, msg, self) => {
        if (self) return;
        if (msg.trim() === "...") {
            streak++;
            if (streak >= 3 && !cooldown) {
                cricket.play();
                log("played sound");
                cooldown = true;
                setTimeout(() => cooldown = false, 10000);
                streak = 0;
            }
        } else {
            streak = 0;
        }
    });
};
</script>
</body>
</html>
