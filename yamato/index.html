<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YamatosDeath</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="chatlib.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center h-screen relative">
    <!-- Updated version tracker -->
    <div class="absolute bottom-4 left-4 text-xs text-gray-500">
        v0.0.9
    </div>

    <div class="text-center p-8 bg-gray-800 rounded-lg shadow-xl space-y-6">
        <div>
            <p class="text-lg text-gray-400 mb-2">Listening to channels: <span id="channel-display" class="font-mono text-green-400"></span></p>
        </div>
        
        <!-- Crickets Status -->
        <div class="bg-gray-700 p-4 rounded-md">
            <p class="text-sm font-bold text-gray-300">Crickets Trigger ("...")</p>
            <div id="crickets-status" class="text-2xl font-semibold">Waiting for messages...</div>
        </div>

        <!-- Sitcom Laugh Status -->
        <div class="bg-gray-700 p-4 rounded-md">
            <p class="text-sm font-bold text-gray-300">Sitcom Laugh Trigger ("LOL", "LO", "KLO")</p>
            <div id="sitcom-status" class="text-2xl font-semibold">Waiting for messages...</div>
        </div>

        <!-- Volume Display -->
        <div class="text-xs text-gray-400 border-t border-gray-600 pt-4">
            <p>Crickets Volume: <span id="cricket-vol-display" class="font-mono"></span>%</p>
            <p>Sitcom Volume: <span id="sitcom-vol-display" class="font-mono"></span>%</p>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const channelNames = ['yamatosdeath', 'athernals7'];
        const triggerCount = 3;
        const cooldownDuration = 10000; // 10 seconds in milliseconds

        const cricketTrigger = '...';
        const sitcomTriggers = ['LOL', 'LO', 'KLO'];
        // ---------------------

        function getUrlParam(name, defaultValue) {
            const urlParams = new URLSearchParams(window.location.search);
            const param = urlParams.get(name);
            if (param && !isNaN(param) && param >= 0 && param <= 100) {
                return parseInt(param, 10);
            }
            return defaultValue;
        }

        const cricketVolume = getUrlParam('crickets', 100);
        const sitcomVolume = getUrlParam('sitcom', 40);

        const channelDisplayElement = document.getElementById('channel-display');
        const cricketsStatusElement = document.getElementById('crickets-status');
        const sitcomStatusElement = document.getElementById('sitcom-status');
        const cricketVolDisplay = document.getElementById('cricket-vol-display');
        const sitcomVolDisplay = document.getElementById('sitcom-vol-display');

        let cricketConsecutiveCount = 0;
        let sitcomConsecutiveCount = 0;
        let cricketsOnCooldown = false;
        let sitcomOnCooldown = false;

        channelDisplayElement.textContent = channelNames.join(', ');
        cricketVolDisplay.textContent = cricketVolume;
        sitcomVolDisplay.textContent = sitcomVolume;

        function updateCricketsStatus() {
            if (cricketsOnCooldown) {
                cricketsStatusElement.textContent = 'On Cooldown...';
                cricketsStatusElement.classList.add('text-yellow-400');
            } else {
                cricketsStatusElement.textContent = `Count: ${cricketConsecutiveCount} / ${triggerCount}`;
                cricketsStatusElement.classList.remove('text-yellow-400');
            }
        }

        function updateSitcomStatus() {
            if (sitcomOnCooldown) {
                sitcomStatusElement.textContent = 'On Cooldown...';
                sitcomStatusElement.classList.add('text-yellow-400');
            } else {
                sitcomStatusElement.textContent = `Count: ${sitcomConsecutiveCount} / ${triggerCount}`;
                sitcomStatusElement.classList.remove('text-yellow-400');
            }
        }

        function playSound(soundFile) {
            console.log(`[SFX] Playing sound: ${soundFile}`);
            const audio = new Audio(`${soundFile}.mp3`);

            if (soundFile === 'crickets') {
                audio.volume = cricketVolume / 100;
            } else if (soundFile === 'sitcom') {
                audio.volume = sitcomVolume / 100;
            }

            const playPromise = audio.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => console.error(`[SFX] Audio playback failed for ${soundFile}:`, error));
            }
        }

        const client = new tmi.Client({ channels: channelNames });
        client.connect().catch(console.error);

        client.on('message', (channel, tags, message, self) => {
            if (self) return;

            const trimmedMessage = message.trim();
            const upperCaseMessage = trimmedMessage.toUpperCase();

            // --- REVISED LOGIC ---
            // The logic here is designed to be sequential.
            // If a message is a sitcom trigger (LOL, LO, KLO), the sitcom counter goes up by one,
            // and the cricket counter is reset because the streak of "..." is broken.
            // If a message is a cricket trigger ("..."), the cricket counter goes up,
            // and the sitcom counter is reset because the streak of laughs is broken.
            // If the message is anything else, both streaks are broken and both counters reset.
            // This ensures that only consecutive messages of the same type are counted.
            const isCricketTrigger = trimmedMessage.startsWith(cricketTrigger);
            const isSitcomTrigger = sitcomTriggers.includes(upperCaseMessage);

            // Added detailed logging to help debug if other chat messages are interfering.
            console.log(`[SFX] Message in #${channel} from ${tags['display-name']}: "${message}"`);
            console.log(`[SFX] Counts Before: Crickets=${cricketConsecutiveCount}, Sitcom=${sitcomConsecutiveCount}`);

            if (isCricketTrigger) {
                cricketConsecutiveCount++;
                sitcomConsecutiveCount = 0; 
            } else if (isSitcomTrigger) {
                sitcomConsecutiveCount++;
                cricketConsecutiveCount = 0; 
            } else {
                cricketConsecutiveCount = 0;
                sitcomConsecutiveCount = 0;
            }
            
            console.log(`[SFX] Counts After: Crickets=${cricketConsecutiveCount}, Sitcom=${sitcomConsecutiveCount}`);

            // Check for Cricket trigger activation
            if (cricketConsecutiveCount >= triggerCount && !cricketsOnCooldown) {
                playSound('crickets');
                cricketsOnCooldown = true;
                cricketConsecutiveCount = 0;
                updateCricketsStatus();
                setTimeout(() => {
                    cricketsOnCooldown = false;
                    updateCricketsStatus();
                }, cooldownDuration);
            }

            // Check for Sitcom trigger activation
            if (sitcomConsecutiveCount >= triggerCount && !sitcomOnCooldown) {
                playSound('sitcom');
                sitcomOnCooldown = true;
                sitcomConsecutiveCount = 0;
                updateSitcomStatus();
                setTimeout(() => {
                    sitcomOnCooldown = false;
                    updateSitcomStatus();
                }, cooldownDuration);
            }

            updateCricketsStatus();
            updateSitcomStatus();
        });
        
        // Initial UI update
        updateCricketsStatus();
        updateSitcomStatus();
    </script>
</body>
</html>
